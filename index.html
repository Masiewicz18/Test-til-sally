<!doctype html>
<html lang="da">
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Plus Pack – Produktionsstop (Legacy Edge kompatibel)</title>

<!-- === LEGACY EDGE (EDGEHTML) COMPAT PACK ================================= -->
<script>
// Små polyfills til den første Edge (EdgeHTML)
(function(){
  if(!window.Object.assign){
    Object.assign = function(target){
      if (target == null) throw new TypeError('Cannot convert undefined or null to object');
      var to = Object(target);
      for (var i=1;i<arguments.length;i++){
        var src = arguments[i]; if(src!=null){
          for (var key in src){ if(Object.prototype.hasOwnProperty.call(src,key)){ to[key]=src[key]; } }
        }
      }
      return to;
    };
  }
  if(!Array.from){
    Array.from = function(arr){ return [].slice.call(arr); };
  }
  if(!String.prototype.includes){
    String.prototype.includes = function(s, i){ return this.indexOf(s, i||0) !== -1; };
  }
  if(!window.CustomEvent){
    function CustomEvent(event, params){
      params = params || {bubbles:false,cancelable:false,detail:undefined};
      var evt = document.createEvent('CustomEvent');
      evt.initCustomEvent(event, params.bubbles, params.cancelable, params.detail);
      return evt;
    }
    CustomEvent.prototype = window.Event.prototype;
    window.CustomEvent = CustomEvent;
  }
})();
</script>

<style>
:root{
  --brand:#0a61ae; --bg:#f6f8fb; --panel:#fff; --divider:#e7edf4;
  --text:#0f172a; --muted:#64748b; --ok:#22c55e; --warn:#f59e0b;
  --danger:#ef4444; --accent:#2563eb; --accent2:#06b6d4;
  --shadow:0 6px 24px rgba(15,23,42,.06)
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{margin:0;font-family:Segoe UI,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
.brand{background:var(--brand);color:#fff;padding:12px 18px;font-weight:800;letter-spacing:.2px}
.container{max-width:1160px;margin:0 auto;padding:16px}
.card{background:var(--panel);border:1px solid var(--divider);border-radius:16px;padding:16px;margin-bottom:14px;box-shadow:var(--shadow)}
.muted{color:var(--muted)} .right{text-align:right}
label{font-size:12px;color:var(--muted)}
input,select,textarea{border:1px solid var(--divider);border-radius:10px;padding:10px 12px;background:#fff;color:var(--text)}
textarea{min-height:84px}
.btn{border:1px solid var(--divider);background:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:800}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.grid{display:grid;gap:12px}.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr 1fr}
.field{display:grid;gap:6px}
.pill{padding:2px 8px;border:1px solid #d8e0eb;border-radius:999px;background:#fff;font-size:12px}

/* Tabs/status */
.tabs{display:flex;gap:8px;background:#fff;border-bottom:1px solid var(--divider);padding:8px 10px;align-items:center;position:sticky;top:0;z-index:9}
.tab{border:0;background:transparent;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:800}
.tab.active{background:#f8fafc;border:1px solid var(--divider)}
.status{margin-left:auto;display:inline-flex;gap:10px;align-items:center;background:#fff;border:1px solid var(--divider);padding:6px 10px;border-radius:999px}
.dot{width:12px;height:12px;border-radius:999px;background:var(--ok);box-shadow:0 0 0 2px rgba(0,0,0,.04) inset}

/* Handling CTA */
.actions{display:grid;gap:16px}.cta{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.btn-stop{background:linear-gradient(180deg, rgba(220,38,38,.10), rgba(220,38,38,.04));border-color:#f2aaaa;color:#7f1d1d;font-size:22px;padding:18px}
.btn-start{background:linear-gradient(180deg, rgba(16,185,129,.10), rgba(16,185,129,.04));border-color:#a6e3b9;color:#065f46;font-size:22px;padding:18px}
.details{border:1px dashed #d8e0eb;border-radius:14px;padding:12px;background:#fbfdff}

/* BIG timer */
.bigTimer{margin:10px 0 0;font:700 44px/1.1 ui-monospace,Consolas,monospace;letter-spacing:.5px;color:#111827}
.bigTimer .lbl{display:block;font:600 12px/1 Segoe UI,Arial;color:var(--muted);letter-spacing:.2px;margin-bottom:4px}

/* 8-timers aktivitet */
.activity{width:100%;height:140px}
.activity .gridline{stroke:#e5e7eb;stroke-width:1}.activity .gridline.sub{opacity:.5}
.activity .now{stroke:var(--brand);stroke-width:2}
.activity .runbg{fill:rgba(16,185,129,.06)} .activity .label{fill:#475569;font-size:10px}
.activity .stop{fill:rgba(220,38,38,.28);stroke:#dc2626;stroke-width:1}

/* Chips */
.chips{display:flex;flex-wrap:wrap;gap:10px}
.chip{display:inline-flex;align-items:center;gap:10px;border:1px solid #d8e0eb;background:#f2f6fb;padding:10px 12px;border-radius:999px;font-size:13px;cursor:pointer}
.chip input{width:16px;height:16px}
.chip-radio.selected{background:#e8f1ff;border-color:var(--accent);font-weight:700}
.chip-check.selected{background:#ecfdf5;border-color:var(--accent2);font-weight:700}

/* Log-liste */
.logcard h4{margin:0 0 8px;font-weight:900}
.loglist{list-style:none;margin:0;padding:0;max-height:180px;overflow:auto;border:1px dashed #d8e0eb;border-radius:12px;background:#fff}
.loglist li{display:grid;grid-template-columns:140px 1fr;gap:10px;padding:8px 10px;border-bottom:1px solid #eef2f7}
.loglist li:last-child{border-bottom:0}.loglist .ts{color:var(--muted);font-size:12px}.loglist .tag{display:inline-block;border:1px solid #e2e8f0;background:#f8fafc;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px}

/* Dark & temaer */
html[data-theme="dark"] body{background:#0b1220;color:#e5e7eb}
html[data-theme="dark"] .tabs,html[data-theme="dark"] .card,html[data-theme="dark"] .status{background:#111827;border-color:#1f2937}
html[data-theme="dark"] .btn,html[data-theme="dark"] input,html[data-theme="dark"] select,html[data-theme="dark"] textarea{background:#0f172a;border-color:#1f2937;color:#e5e7eb}
html[data-theme="dark"] .muted{color:#9ca3af}

/* Stats-grid og komponenter */
.stats-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
.kpi{background:#f8fafc;border:1px solid var(--divider);border-radius:12px;padding:10px}.kpi .val{font-weight:900;font-size:24px}
.panel{border:1px solid var(--divider);border-radius:12px;padding:12px}
.chart{width:100%;height:220px}
.legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}.legend .pill{display:inline-flex;align-items:center;gap:6px}
.barlist{display:grid;gap:8px}.barrow{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
.bar{height:10px;border-radius:999px;background:linear-gradient(90deg,#c7d2fe,#93c5fd)}
.small{font-size:12px}.select{min-width:220px}

/* Simple inline modal-kort (erstattet popups i Edge) */
.inline-panel{border:1px dashed var(--divider);border-radius:12px;padding:12px;background:#fff}
</style>

<!-- Vedvarende STOP-status -->
<script>
const CURRENT_STOP = 'produktionsstop.current.v1';
function loadCurrentStop(){ try { return JSON.parse(localStorage.getItem(CURRENT_STOP)); } catch(e){ return null; } }
function saveCurrentStop(obj){ localStorage.setItem(CURRENT_STOP, JSON.stringify(obj)); }
function clearCurrentStop(){ localStorage.removeItem(CURRENT_STOP); }
</script>
</head>
<body>
  <div class="brand">Plus Pack – Produktionsstop</div>
  <div class="tabs">
    <button class="tab active" id="tab-handling" type="button">Handling</button>
    <button class="tab" id="tab-stats" type="button">Stop-statistik</button>
    <button class="tab" id="tab-hist" type="button">Historik</button>
    <button class="tab" id="tab-share" type="button">Deling</button>
    <button class="tab" id="tab-settings" type="button">Indstillinger</button>
    <div class="status"><span class="dot" id="dot"></span><span id="statxt">Kører</span></div>
  </div>

  <div class="container">

    <!-- Handling -->
    <section id="view-handling">
      <div class="card">
        <div class="actions">
          <div class="cta">
            <button class="btn btn-stop" id="btn-stop" type="button">⏹ STOP (Ctrl+S)</button>
            <button class="btn btn-start" id="btn-start" type="button" disabled>▶ START (Ctrl+A)</button>
          </div>
          <div class="bigTimer"><span class="lbl">Aktuelt stop</span><span id="liveTimer">—</span></div>

          <!-- INLINE “Registrér stop” (ingen modal/pop-up for Edge) -->
          <div class="inline-panel" id="stopInline" style="display:none">
            <div style="font-weight:800;margin-bottom:6px">Registrér stop</div>
            <div class="grid grid-2">
              <div>
                <label>Årsag</label>
                <div class="chips" id="reasonTop"></div>
                <div class="chips" id="reasonMore" style="margin-top:8px"></div>
              </div>
              <div>
                <label>Uddybning (chips)</label>
                <div class="chips" id="reasonChips"></div>
              </div>
            </div>
            <div class="grid grid-2" style="margin-top:8px">
              <div class="field"><label>Andet</label><input id="other" type="text"/></div>
              <div class="field"><label>Kommentar</label><input id="comment" type="text"/></div>
            </div>
            <p id="stopValidation" class="muted" style="margin:6px 0 0"></p>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
              <button class="btn" id="stop-cancel" type="button">Annuller</button>
              <button class="btn btn-stop" id="stop-confirm" type="button">Bekræft stop</button>
            </div>
          </div>

          <div class="details" style="margin-top:8px">
            <div class="grid grid-3">
              <div class="field"><label>Linje / maskine</label>
                <select id="line">
                  <option value="">— Vælg maskine —</option>
                  <option>L10 75 t Rhodes special presse</option>
                  <option>L11 Mech RF135 serie nr 18-11 Mnr888</option>
                  <option disabled>L12 30 t Flexo C30 S15  INAKTIV</option>
                  <option>L13 Press Beutler PD 40</option>
                  <option>L14 50 t Flexo C50 S20 presse</option>
                  <option>L15 30 t Flexo C30 S15 presse</option>
                  <option>L16 40 t Schuler PNH 40/250 presse</option>
                  <option>L17 30 t Flexo C30 S15 presse</option>
                  <option>L20 50 t Bliss 50F MKII presse</option>
                  <option>L22 50 t Bliss 50F MKII presse</option>
                  <option>L23 45 t Bliss 21½ presse</option>
                  <option>L24 30 t Flexo C30 S15</option>
                  <option>L25 30 t Flexo C30 X presse</option>
                  <option>L26 L 36 30 t Flexo C30 S 15 presse</option>
                  <option>L27 45 t Bliss 21½ presse</option>
                  <option>L28 50 t Flexo presse</option>
                  <option>L29 30 t Flexo C30 presse</option>
                  <option>L30 ny presse 2012</option>
                  <option>L33 50 t Bliss 50F MKII presse</option>
                  <option>L34 50 t Bliss 50F MKII presse</option>
                  <option>L35 30 t Flexo C30 S15 presse</option>
                  <option>L36 30 t Flexo C30 S15 presse Picop</option>
                  <option>L40 50 t Flexo C50 S20 presse</option>
                  <option>L41 L37, 50 t Bliss 50F MKII presse</option>
                  <option>L42 Press Beutler PD 40 alu spez638</option>
                  <option>L43 Press Beutler PD 40 alu spez637</option>
                  <option>L80 Choko-kapsler</option>
                  <option>L81 Lys-manchetter</option>
                  <option>L82 Lys-manchetter</option>
                </select>
              </div>
              <div class="field"><label>Ordre nr. (krævet)</label><input id="orderNo" type="text"/></div>
              <div class="field"><label>Vare nr. (krævet)</label><input id="itemNo" type="text"/></div>
            </div>
            <div class="grid grid-3" style="margin-top:8px">
              <div class="field"><label>Operatør (valgfri)</label><input id="operator" type="text" placeholder="Navn/initialer"/></div>
              <div class="field"><label>&nbsp;</label><button class="btn" id="btn-clear-order" type="button">Ryd ordre</button></div>
              <div class="field"><label>&nbsp;</label>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  <button class="btn" id="btn-clear-line" type="button">Ryd linje/navn</button>
                  <button class="btn" id="btn-open-rep" type="button">Åbn rep-seddel</button>
                </div>
              </div>
            </div>
          </div><!-- /details -->
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px;font-weight:900">Aktivitet – sidste 8 timer</h3>
        <svg class="activity" viewBox="0 0 920 140" id="activity8h"></svg>
        <p class="muted small" style="margin-top:6px">Røde felter = registrerede stop. Højre kant er nu.</p>
      </div>

      <div class="card logcard">
        <h4>Aktivitetslog (sidste 8 timer)</h4>
        <ul class="loglist" id="log8h"></ul>
      </div>

      <div class="card handover">
        <h4 style="margin:0 0 8px;font-weight:900">Overlevering / skift-noter</h4>
        <div class="grid grid-2">
          <div class="field"><label>Noter til næste skift</label>
            <textarea id="handoverText" placeholder="Skriv kort status, åbne punkter, kendte fejl osv."></textarea></div>
          <div class="field"><label>Tag (valgfrit)</label>
            <input id="handoverTag" type="text" placeholder="fx Vedligehold, Kvalitet, Værktøj"/></div>
        </div>
        <div class="actions" style="margin-top:8px">
          <button class="btn btn-start" id="handoverSave" type="button">Gem note</button>
          <button class="btn" id="handoverClear" type="button">Ryd felt</button>
        </div>
        <div class="handover list" id="handoverList" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- Stop-statistik -->
    <section id="view-stats" style="display:none">
      <div class="card">
        <div class="grid" style="grid-template-columns:1fr auto;align-items:center;margin-bottom:8px">
          <h3 style="margin:0">Stop-statistik</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="small">Skift:</label>
            <select id="shiftSelect" class="select">
              <option value="all">Alle stop</option>
              <option value="current">Nuværende skift</option>
              <option value="day">Dag (06-14)</option>
              <option value="evening">Aften (14-22)</option>
              <option value="night">Nat (22-06)</option>
            </select>
            <label class="small">Vis:</label>
            <select id="paretoMode" class="select">
              <option value="freq">Procentfordeling (hyppighed)</option>
              <option value="dur">Procentfordeling (varighed)</option>
            </select>
          </div>
        </div>

        <div class="stats-grid">
          <div class="kpi" style="grid-column:span 3"><div class="small muted">Antal stop</div><div class="val" id="kpi-count">0</div><div class="small muted">Poster i alt</div></div>
          <div class="kpi" style="grid-column:span 3"><div class="small muted">Samlet varighed</div><div class="val" id="kpi-dur">00:00:00</div><div class="small muted">hh:mm:ss</div></div>
          <div class="kpi" style="grid-column:span 3"><div class="small muted">Gns. pr. stop</div><div class="val" id="kpi-avg">00:00:00</div><div class="small muted">hh:mm:ss</div></div>
          <div class="kpi" style="grid-column:span 3"><div class="small muted">Top-årsag</div><div class="val" id="kpi-top">—</div><div class="small muted" id="kpi-top-sub">Hyppigst: —</div></div>

          <div class="panel" style="grid-column:span 6">
            <div class="small muted" style="margin-bottom:6px">Hyppighed – andele</div>
            <svg class="chart" id="pie-freq" viewBox="0 0 240 240"></svg>
            <div class="legend" id="legend-freq"></div>
          </div>
          <div class="panel" style="grid-column:span 6">
            <div class="small muted" style="margin-bottom:6px">Varighed – andele</div>
            <svg class="chart" id="pie-dur" viewBox="0 0 240 240"></svg>
            <div class="legend" id="legend-dur"></div>
          </div>

          <div class="panel" style="grid-column:span 6">
            <div class="small" style="font-weight:800;margin-bottom:8px">Hyppighed (antal pr. årsag)</div>
            <div class="barlist" id="bars-freq"></div>
          </div>
          <div class="panel" style="grid-column:span 6">
            <div class="small" style="font-weight:800;margin-bottom:8px">Varighed (sum pr. årsag)</div>
            <div class="barlist" id="bars-dur"></div>
          </div>

          <div class="panel" style="grid-column:span 12">
            <div class="grid" style="grid-template-columns:1fr auto;align-items:center;margin-bottom:8px">
              <div style="font-weight:800">Pareto</div>
              <div class="small muted">Kumulativ %</div>
            </div>
            <svg class="chart" id="pareto" viewBox="0 0 760 260"></svg>
          </div>
        </div>
      </div>
    </section>

    <!-- Historik -->
    <section id="view-hist" style="display:none">
      <div class="card">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
          <strong>Poster:</strong><span id="countPosts">0</span>
          <strong style="margin-left:12px">Plads:</strong><span id="usageTxt">0%</span>
          <div class="usage" style="height:8px;background:#eef2f7;border:1px solid var(--divider);border-radius:999px;overflow:hidden;width:180px;display:inline-block;vertical-align:middle;margin-left:6px"><div id="usageFill" style="height:100%;width:0;background:linear-gradient(90deg,#c7d2fe,#93c5fd)"></div></div>
          <button class="btn" id="btn-archive" type="button" style="margin-left:auto">Arkivér & nulstil</button>
        </div>
        <div style="overflow:auto;max-height:60vh;border:1px solid var(--divider);border-radius:10px">
          <table style="width:100%;border-collapse:collapse">
            <thead><tr style="background:#f8fafc">
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Start</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Slut</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Varighed</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Linje</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Ordre</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Vare</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Kode</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Uddybning</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Kommentar</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Operatør</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid var(--divider)">Handling</th>
            </tr></thead>
            <tbody id="tbl-body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Deling -->
    <section id="view-share" style="display:none">
      <div class="card">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btn-csv" type="button">Eksporter CSV</button>
          <button class="btn" id="btn-json" type="button">Kopiér JSON</button>
          <button class="btn" id="btn-email" type="button">Send til mail</button>
          <button class="btn" id="btn-clear-log" type="button">Nulstil log</button>
        </div>
        <p class="muted small">Data gemmes lokalt i browseren (localStorage).</p>
      </div>
    </section>

    <!-- Indstillinger -->
    <section id="view-settings" style="display:none">
      <div class="card">
        <div class="grid grid-2">
          <div class="field"><label>Standard-modtager</label><input id="defTo" type="email" placeholder="vedligehold@pluspack.com"/></div>
          <div class="field"><label>Brandfarve</label><input id="brandColor" type="text" placeholder="#0a61ae"/></div>
        </div>
        <div class="grid grid-2" style="margin-top:8px">
          <div class="field"><label>Farvetema</label>
            <select id="themeSelect">
              <option value="standard">Standard (pasteller)</option>
              <option value="mono">Mono-blå</option>
              <option value="dark">Mørk</option>
            </select>
          </div>
          <div class="field"><label>&nbsp;</label><button class="btn" id="btn-save-settings" type="button">Gem indstillinger</button></div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">Årsager</h3>
        <div class="grid grid-2">
          <div class="field"><label>Kode (fx PRES)</label><input id="causeCode" type="text" placeholder="KODE"/></div>
          <div class="field"><label>Navn/label</label><input id="causeLabel" type="text" placeholder="Beskrivelse"/></div>
        </div>
        <div class="field" style="margin-top:8px"><label>Uddybning (chips, kommasepareret)</label><input id="causeChips" type="text" placeholder="fx Rensning, Sikkerhed, Opsætning"/></div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btn-add-cause" type="button">Tilføj årsag</button>
          <button class="btn" id="btn-reset-causes" type="button">Nulstil til standard</button>
        </div>
        <div id="causeList" style="margin-top:8px"></div>
      </div>
    </section>
  </div><!-- /.container -->

<script>
/* ========================= KONFIGURATION – ENDPOINTS ====================== */
var ENDPOINT_STOP  = "#";   // POST: afsluttet stop (samlet payload)
var ENDPOINT_EVENT = "#";   // POST: hændelse/info fra “Handling”
var ENDPOINT_REP   = "#";   // POST: rep-seddel
var ENDPOINT_INFO  = "#";   // POST: info-note

/* ========================= XHR-baseret POST (ingen fetch) ================= */
function postJSON(url, payload){
  return new Promise(function(resolve){
    if(!url || url === '#'){ resolve(true); return; }
    try{
      var xhr = new XMLHttpRequest();
      xhr.open('POST', url, true);
      xhr.setRequestHeader('Content-Type','application/json;charset=UTF-8');
      xhr.onreadystatechange = function(){
        if(xhr.readyState === 4){
          if(xhr.status >= 200 && xhr.status < 300){ resolve(true); }
          else {
            try {
              var q = loadQ ? loadQ() : [];
              q.push({url:url, payload:payload});
              if(saveQ) saveQ(q);
            } catch(e){}
            resolve(false);
          }
        }
      };
      xhr.send(JSON.stringify(payload));
    }catch(e){
      try{
        var q2 = loadQ ? loadQ() : [];
        q2.push({url:url, payload:payload});
        if(saveQ) saveQ(q2);
      }catch(_){}
      resolve(false);
    }
  });
}

/* ========================= Helpers & storage ============================== */
function $(id){ return document.getElementById(id); }
function addClass(el,c){ if(!el) return; if((' '+el.className+' ').indexOf(' '+c+' ')<0) el.className+=(el.className?' ':'')+c; }
function remClass(el,c){ if(!el) return; el.className=el.className.split(' ').filter(function(x){return x!==c}).join(' '); }
function show(el){ if(el) el.style.display=''; } function hide(el){ if(el) el.style.display='none'; }
function pad(n){ return (n<10?'0':'')+n; }
function fmtDate(d){ var dt=(d instanceof Date)?d:new Date(d); try{ return dt.toLocaleString('da-DK'); }catch(e){ return dt.toString(); } }
function fmtDur(ms){ var s=Math.floor((ms||0)/1000),h=pad(Math.floor(s/3600)),m=pad(Math.floor((s%3600)/60)),ss=pad(s%60); return h+':'+m+':'+ss; }
function fmtShortDur(ms){ var s=Math.floor((ms||0)/1000),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),ss=s%60; return h>0?(h+'t '+(m<10?'0':'')+m+'m'):((m>0?m+'m ':'')+((ss<10?'0':'')+ss)+'s'); }
function bytesLen(str){ return unescape(encodeURIComponent(str||'')).length; }
function uuid(){ return 'id-'+Date.now()+'-'+Math.floor(Math.random()*1e6); }

/* LocalStorage keys */
var STORAGE='produktionsstop.events.v2';
var SETTINGS='produktionsstop.settings.v2';
var HANDOVER='produktionsstop.handover.v1';
var HANDOVER_DRAFT='produktionsstop.handoverDraft.v1';

/* Offline-kø (frivillig – brugt af postJSON når server ikke kan nås) */
var QKEY='produktionsstop.queue.v1';
function loadQ(){ try { return JSON.parse(localStorage.getItem(QKEY))||[] } catch(e){ return [] } }
function saveQ(arr){ localStorage.setItem(QKEY, JSON.stringify(arr||[])); }

/* Standard årsager */
var DEFAULT_REASONS=[
  {code:'PRES', label:'Presse', chips:['Rensning','Smøring','Opsætning']},
  {code:'VAERK',label:'Værktøj',chips:['Skift','Slid','Defekt']},
  {code:'STAK' ,label:'Stakker', chips:['Fejl','Opsamler','Andet']},
  {code:'FOLIE',label:'Manglende folie',chips:['Påfyld','Bestilling']},
  {code:'ORDRE',label:'Manglende ordre',chips:['Afventer','Uklar ordre']},
  {code:'ANDET',label:'Andet',chips:['Sikkerhed','Rengøring']}
];

/* Load/Save */
function loadEvents(){ try { return JSON.parse(localStorage.getItem(STORAGE))||[] } catch(e){ return [] } }
function saveEvents(x){ localStorage.setItem(STORAGE, JSON.stringify(x)); }
function loadSettings(){ try { return JSON.parse(localStorage.getItem(SETTINGS))||{} } catch(e){ return {} } }
function saveSettings(x){ localStorage.setItem(SETTINGS, JSON.stringify(x)); }
function loadHandover(){ try { return JSON.parse(localStorage.getItem(HANDOVER))||[] } catch(e){ return [] } }
function saveHandover(x){ localStorage.setItem(HANDOVER, JSON.stringify(x)); }
function loadDraft(){ try { return JSON.parse(localStorage.getItem(HANDOVER_DRAFT))||{txt:'',tag:''} } catch(e){ return {txt:'',tag:''} } }
function saveDraft(obj){ localStorage.setItem(HANDOVER_DRAFT, JSON.stringify(obj)); }
function clearDraft(){ localStorage.removeItem(HANDOVER_DRAFT); }

function getAllReasons(){
  var s=loadSettings(), custom=s.customCauses||[], map={}, out=[];
  DEFAULT_REASONS.forEach(function(r){ map[r.code]=r; });
  custom.forEach(function(c){ map[c.code]={code:c.code,label:c.label,chips:c.chips||[]}; });
  for(var k in map) out.push(map[k]);
  return out;
}

/* ========================= UI refs ======================================== */
var els={
  tabHandling:$('tab-handling'), tabStats:$('tab-stats'), tabHist:$('tab-hist'), tabShare:$('tab-share'), tabSettings:$('tab-settings'),
  viewHandling:$('view-handling'), viewStats:$('view-stats'), viewHist:$('view-hist'), viewShare:$('view-share'), viewSettings:$('view-settings'),
  dot:$('dot'), statxt:$('statxt'), btnStop:$('btn-stop'), btnStart:$('btn-start'),
  line:$('line'), operator:$('operator'), orderNo:$('orderNo'), itemNo:$('itemNo'),
  btnClearOrder:$('btn-clear-order'), btnClearLine:$('btn-clear-line'), btnOpenRep:$('btn-open-rep'),
  liveTimer:$('liveTimer'), activity:$('activity8h'), log8h:$('log8h'),
  stopInline:$('stopInline'), stopCancel:$('stop-cancel'), stopConfirm:$('stop-confirm'),
  reasonTop:$('reasonTop'), reasonMore:$('reasonMore'), reasonChips:$('reasonChips'), other:$('other'), comment:$('comment'), stopValidation:$('stopValidation'),
  // Handover
  handoverText:$('handoverText'), handoverTag:$('handoverTag'), handoverSave:$('handoverSave'), handoverClear:$('handoverClear'), handoverList:$('handoverList'),
  // stats
  shiftSelect:$('shiftSelect'), paretoMode:$('paretoMode'),
  pieFreq:$('pie-freq'), pieDur:$('pie-dur'), legendFreq:$('legend-freq'), legendDur:$('legend-dur'),
  barsFreq:$('bars-freq'), barsDur:$('bars-dur'), pareto:$('pareto'),
  kpiCount:$('kpi-count'), kpiDur:$('kpi-dur'), kpiAvg:$('kpi-avg'), kpiTop:$('kpi-top'), kpiTopSub:$('kpi-top-sub'),
  // historik
  tableBody:$('tbl-body'), countPosts:$('countPosts'), usageTxt:$('usageTxt'), usageFill:$('usageFill'), btnArchive:$('btn-archive'),
  // deling
  btnCsv:$('btn-csv'), btnJson:$('btn-json'), btnEmail:$('btn-email'), btnClearLog:$('btn-clear-log'),
  // settings
  defTo:$('defTo'), brandColor:$('brandColor'), themeSelect:$('themeSelect'),
  btnSaveSettings:$('btn-save-settings')
};

/* ========================= Status & timer ================================= */
var timer=null, IS_STOPPED=false, STOP_START_ISO=null, stopMeta=null;
function setStatus(st){
  IS_STOPPED=st;
  els.btnStop.disabled=st; els.btnStart.disabled=!st;
  els.dot.style.background=st?'var(--danger)':'var(--ok)';
  els.statxt.textContent=st?'Stoppet':'Kører';
  els.liveTimer.textContent=st?'00:00:00':'—';
}
function tick(){
  if(!IS_STOPPED) return;
  var ms=Date.now()-new Date(STOP_START_ISO);
  els.liveTimer.textContent=fmtDur(ms);
  renderActivity8h(); renderLog8h();
}

/* ========================= Årsag + chips ================================== */
function reasonList(){ return getAllReasons().slice().sort(function(a,b){ return a.label.localeCompare(b.label); }); }
function getReasonByCode(code){ var list=getAllReasons(); for(var i=0;i<list.length;i++){ if(list[i].code===code) return list[i]; } return null; }
function renderChipsByCode(code){
  var r=getReasonByCode(code)||{chips:[]};
  var html='', chips=r.chips||[];
  for(var i=0;i<chips.length;i++){
    html+='<label class="pill" style="display:inline-flex;align-items:center;gap:8px"><input type="checkbox" value="'+chips[i]+'">'+chips[i]+'</label>';
  }
  els.reasonChips.innerHTML=html;
}
function selectedChips(){
  var boxes=els.reasonChips.querySelectorAll('input[type="checkbox"]');
  var out=[]; for(var i=0;i<boxes.length;i++){ if(boxes[i].checked) out.push(boxes[i].value); }
  return out;
}
function onReasonAreaClick(e){
  var t=e.target;
  if(t && t.name==='reasonRadio'){
    renderChipsByCode(t.value);
    els.stopValidation.textContent='';
  }
}
function renderReasonButtons(){
  var list=reasonList(), top=list.slice(0,8), more=list.slice(8);
  function mk(c,l){ return '<label class="pill" style="display:inline-flex;align-items:center;gap:8px"><input type="radio" name="reasonRadio" value="'+c+'"><span>'+c+' — '+l+'</span></label>'; }
  els.reasonTop.innerHTML=top.map(function(r){return mk(r.code,r.label)}).join('');
  els.reasonMore.innerHTML=more.map(function(r){return mk(r.code,r.label)}).join('');
  var first=els.reasonTop.querySelector('input[name="reasonRadio"]')||els.reasonMore.querySelector('input[name="reasonRadio"]');
  if(first){ first.checked=true; renderChipsByCode(first.value); }
  els.reasonTop.onclick=onReasonAreaClick; els.reasonMore.onclick=onReasonAreaClick;
}

/* ========================= Aktivitet og log =============================== */
function renderActivity8h(){
  var svg=els.activity; if(!svg) return; svg.innerHTML='';
  var W=920,H=140,m={l:40,r:10,t:20,b:20},w=W-m.l-m.r,h=H-m.t-m.b;
  var now=new Date(); var startWindow=new Date(now.getTime()-8*3600*1000);
  function xPos(t){ return m.l+Math.max(0,Math.min(w,((t-startWindow)/(8*3600*1000))*w)); }
  var rectBg=document.createElementNS('http://www.w3.org/2000/svg','rect'); rectBg.setAttribute('x',m.l); rectBg.setAttribute('y',m.t); rectBg.setAttribute('width',w); rectBg.setAttribute('height',h); rectBg.setAttribute('class','runbg'); svg.appendChild(rectBg);

  var i, x, ln, t;
  for(i=0;i<=8;i++){
    x=m.l+(w*(i/8));
    ln=document.createElementNS('http://www.w3.org/2000/svg','line'); ln.setAttribute('x1',x); ln.setAttribute('y1',m.t); ln.setAttribute('x2',x); ln.setAttribute('y2',m.t+h); ln.setAttribute('class','gridline'); svg.appendChild(ln);
    t=document.createElementNS('http://www.w3.org/2000/svg','text'); var dt=new Date(startWindow.getTime()+i*3600*1000);
    t.setAttribute('x',x+2); t.setAttribute('y',H-4); t.setAttribute('class','label'); t.textContent=pad(dt.getHours())+':00'; svg.appendChild(t);
    if(i<8){
      var xh=x+(w/8)/2; var ln2=document.createElementNS('http://www.w3.org/2000/svg','line');
      ln2.setAttribute('x1',xh); ln2.setAttribute('y1',m.t); ln2.setAttribute('x2',xh); ln2.setAttribute('y2',m.t+h); ln2.setAttribute('class','gridline sub'); svg.appendChild(ln2);
    }
  }

  var rows=loadEvents(),stops=[];
  rows.forEach(function(r){
    if(!r.end) return; var s=new Date(r.start), e=new Date(r.end);
    if(e<startWindow||s>now) return;
    var cs=Math.max(s.getTime(),startWindow.getTime()), ce=Math.min(e.getTime(),now.getTime());
    stops.push([cs,ce]);
  });
  if(IS_STOPPED && STOP_START_ISO){
    var s2=Math.max(new Date(STOP_START_ISO).getTime(),startWindow.getTime());
    var e2=now.getTime(); if(e2>s2) stops.push([s2,e2]);
  }
  stops.forEach(function(seg){
    var xs=xPos(seg[0]), xe=xPos(seg[1]);
    var r=document.createElementNS('http://www.w3.org/2000/svg','rect');
    r.setAttribute('x',xs); r.setAttribute('y',m.t+8); r.setAttribute('width',Math.max(1,xe-xs)); r.setAttribute('height',h-16); r.setAttribute('class','stop'); svg.appendChild(r);
  });
  var xnow=xPos(now), nowLn=document.createElementNS('http://www.w3.org/2000/svg','line'); nowLn.setAttribute('x1',xnow); nowLn.setAttribute('y1',m.t-2); nowLn.setAttribute('x2',xnow); nowLn.setAttribute('y2',m.t+h+2); nowLn.setAttribute('class','now'); svg.appendChild(nowLn);
}
function renderLog8h(){
  var el=els.log8h; if(!el) return; el.innerHTML='';
  var now=new Date(); var startWindow=new Date(now.getTime()-8*3600*1000);
  var rows=loadEvents().filter(function(r){ return r.end && new Date(r.end)>startWindow; }).sort(function(a,b){ return new Date(b.start)-new Date(a.start); });
  if(rows.length===0 && !(IS_STOPPED && STOP_START_ISO)){ el.innerHTML='<li class="muted" style="padding:8px 0">Ingen registreringer i perioden</li>'; return; }
  if(IS_STOPPED && STOP_START_ISO){
    var ms=Date.now()-new Date(STOP_START_ISO);
    var li=document.createElement('li'); li.innerHTML='<span class="ts">NU</span><div><strong>Aktivt stop</strong> <span class="tag">'+fmtDur(ms)+'</span></div>'; el.appendChild(li);
  }
  rows.forEach(function(r){
    var li=document.createElement('li'); var code=(r.reason&&r.reason.code)||'';
    li.innerHTML='<span class="ts">'+fmtDate(r.start)+'</span><div>'+(code?('<span class="tag">'+code+'</span> '):'')+((r.reason&&r.reason.label)||'Stop')+' – <span class="muted">'+fmtDur(r.durationMs||0)+'</span>'+(r.comment?(' · '+r.comment):'')+'</div>';
    el.appendChild(li);
  });
}

/* ========================= Handover (udkast autosave) ===================== */
function renderHandover(){
  var list=loadHandover().sort(function(a,b){ return new Date(b.ts)-new Date(a.ts); });
  var c=els.handoverList; c.innerHTML='';
  if(!list.length){ c.innerHTML='<div class="item"><div class="muted small">Ingen noter endnu</div></div>'; return; }
  list.forEach(function(row,idx){
    var d=document.createElement('div'); d.className='item';
    d.style.border='1px solid var(--divider)'; d.style.borderRadius='12px'; d.style.padding='10px'; d.style.background='#fff';
    d.innerHTML='<div class="muted small">'+fmtDate(row.ts)+(row.tag?(' · '+row.tag):'')+'</div><div>'+row.txt+'</div><div class="right" style="margin-top:6px"><button class="btn" data-i="'+idx+'" type="button">Slet</button></div>';
    c.appendChild(d);
  });
  var btns=c.querySelectorAll('button'); for(var i=0;i<btns.length;i++){
    btns[i].onclick=function(){ var i=parseInt(this.getAttribute('data-i'),10); var arr=loadHandover(); arr.splice(i,1); saveHandover(arr); renderHandover(); };
  }
}
function restoreHandoverDraft(){
  var d=loadDraft();
  if(!els.handoverText.value) els.handoverText.value=d.txt||'';
  if(!els.handoverTag.value)  els.handoverTag.value=d.tag||'';
}
function bindDraftAutosave(){
  function onDraftChange(){ saveDraft({ txt: els.handoverText.value||'', tag: els.handoverTag.value||'' }); }
  els.handoverText.addEventListener('input', onDraftChange);
  els.handoverTag.addEventListener('input', onDraftChange);
}

/* ========================= Stats ========================================= */
function getShiftRange(type, ref){
  if(!ref) ref=new Date();
  var d=new Date(ref), y=d.getFullYear(), m=d.getMonth(), day=d.getDate();
  function at(h){ return new Date(y,m,day,h,0,0); }
  if(type==='day')     return [at(6),  at(14)];
  if(type==='evening') return [at(14), at(22)];
  if(type==='night'){  var s=at(22), e=new Date(y,m,day+1,6,0,0); return [s,e]; }
  if(type==='current'){
    var now=d, ranges=[getShiftRange('day',d),getShiftRange('evening',d),getShiftRange('night',d)];
    for(var i=0;i<ranges.length;i++){ var se=ranges[i], s=se[0], e=se[1]; if(now>=s && now<e) return [s,e]; }
    return getShiftRange('night', new Date(y,m,day-1,23,0,0));
  }
  return [null,null];
}
function filteredEvents(){
  var mode=els.shiftSelect.value||'all';
  if(mode==='all') return loadEvents();
  var se=getShiftRange(mode), s=se[0], e=se[1];
  return loadEvents().filter(function(r){
    var rs=new Date(r.start), re=new Date(r.end||Date.now());
    return (!s || re>=s) && (!e || rs<e);
  });
}
function aggregateByCause(rows){
  var map={}, i;
  for(i=0;i<rows.length;i++){
    var r=rows[i], code=(r.reason&&r.reason.code)||'UKENDT', label=(r.reason&&r.reason.label)||'Ukendt', key=code+'|'+label;
    if(!map[key]) map[key]={code:code,label:label,count:0,dur:0};
    map[key].count+=1; map[key].dur+=(r.durationMs||0);
  }
  var out=[]; for(var k in map) out.push(map[k]);
  out.sort(function(a,b){ return (b.count-a.count) || (b.dur-a.dur); });
  return out;
}
function renderDonut(svgEl, data, getVal){
  svgEl.innerHTML=''; var cx=120, cy=120, r=80, th=28;
  var total=0; for(var i=0;i<data.length;i++) total+=getVal(data[i]); if(total===0) total=1;
  var start=-Math.PI/2;
  var cols=['#22c55e','#93c5fd','#cbd5e1','#a7f3d0','#fca5a5','#fde68a','#ddd','#60a5fa','#34d399','#a78bfa'];
  for(i=0;i<data.length;i++){
    var d=data[i], val=getVal(d), ang=(val/total)*Math.PI*2, end=start+ang, large=ang>Math.PI?1:0;
    var x1=cx+Math.cos(start)*r, y1=cy+Math.sin(start)*r;
    var x2=cx+Math.cos(end)*r,   y2=cy+Math.sin(end)*r;
    var x3=cx+Math.cos(end)*(r-th), y3=cy+Math.sin(end)*(r-th);
    var x4=cx+Math.cos(start)*(r-th), y4=cy+Math.sin(start)*(r-th);
    var p=document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d','M '+x1+' '+y1+' A '+r+' '+r+' 0 '+large+' 1 '+x2+' '+y2+' L '+x3+' '+y3+' A '+(r-th)+' '+(r-th)+' 0 '+large+' 0 '+x4+' '+y4+' Z');
    p.setAttribute('fill',cols[i%cols.length]); svgEl.appendChild(p); start=end;
  }
  var sumTxt=document.createElementNS('http://www.w3.org/2000/svg','text');
  sumTxt.setAttribute('x',cx); sumTxt.setAttribute('y',cy+4); sumTxt.setAttribute('text-anchor','middle'); sumTxt.setAttribute('font-size','20'); sumTxt.setAttribute('font-weight','700');
  var sum=0; for(i=0;i<data.length;i++) sum+=getVal(data[i]); sumTxt.textContent=sum; svgEl.appendChild(sumTxt);
}
function renderLegend(el,data,fmt){
  var cols=['#22c55e','#93c5fd','#cbd5e1','#a7f3d0','#fca5a5','#fde68a','#ddd','#60a5fa','#34d399','#a78bfa'];
  var html='', i;
  for(i=0;i<data.length;i++){
    var d=data[i];
    html+='<span class="pill"><span style="display:inline-block;width:10px;height:10px;border-radius:999px;background:'+cols[i%cols.length]+'"></span>'+d.code+' — '+d.label+' <span class="small muted">'+fmt(d)+'</span></span> ';
  }
  el.innerHTML=html;
}
function renderBars(container,data,fmtVal,relKey){
  var max=1, i; for(i=0;i<data.length;i++) if((data[i][relKey]||0)>max) max=data[i][relKey];
  var html='';
  for(i=0;i<data.length;i++){
    var d=data[i], w=Math.round(((d[relKey]||0)/max)*100);
    html+='<div class="barrow"><div class="small muted" style="min-width:80px">'+d.code+'</div><div class="bar" style="position:relative"><div style="position:absolute;left:0;top:0;bottom:0;width:'+w+'%;background:linear-gradient(90deg,#60a5fa,#2563eb);border-radius:999px"></div></div><div class="small" style="min-width:60px;text-align:right">'+fmtVal(d)+'</div></div>';
  }
  container.innerHTML=html;
}
function renderPareto(svgEl,data,mode){
  svgEl.innerHTML='';
  var W=760,H=260,m={l:40,r:40,t:20,b:28}, w=W-m.l-m.r, h=H-m.t-m.b;
  var g=document.createElementNS('http://www.w3.org/2000/svg','g'); g.setAttribute('transform','translate('+m.l+','+m.t+')'); svgEl.appendChild(g);
  var vals=[], i; for(i=0;i<data.length;i++) vals.push(mode==='freq'?data[i].count:data[i].dur);
  var total=0; for(i=0;i<vals.length;i++) total+=vals[i]; if(total===0) total=1;
  var cum=[], s=0; for(i=0;i<vals.length;i++){ s+=vals[i]; cum.push(s/total); }
  var max=1; for(i=0;i<vals.length;i++) if(vals[i]>max) max=vals[i];
  var ax=document.createElementNS('http://www.w3.org/2000/svg','line'); ax.setAttribute('x1',0); ax.setAttribute('y1',h); ax.setAttribute('x2',w); ax.setAttribute('y2',h); ax.setAttribute('stroke','#e5e7eb'); g.appendChild(ax);
  var step=w/Math.max(vals.length,1);
  for(i=0;i<vals.length;i++){
    var v=vals[i], bh=(v/max)*h, rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x',i*step+10); rect.setAttribute('y',h-bh); rect.setAttribute('width',Math.max(18,step-20)); rect.setAttribute('height',bh); rect.setAttribute('fill','#93c5fd'); g.appendChild(rect);
    var tx=document.createElementNS('http://www.w3.org/2000/svg','text'); tx.setAttribute('x',i*step+step/2); tx.setAttribute('y',h+16); tx.setAttribute('text-anchor','middle'); tx.setAttribute('font-size','10'); tx.textContent=data[i].code; g.appendChild(tx);
  }
  var path=document.createElementNS('http://www.w3.org/2000/svg','path'); var d='M 0 '+h;
  for(i=0;i<cum.length;i++){ var x=i*step+step/2, y=h-(cum[i]*h); d+=' L '+x+' '+y; }
  path.setAttribute('d',d); path.setAttribute('fill','none'); path.setAttribute('stroke','#2563eb'); path.setAttribute('stroke-width','2'); g.appendChild(path);
  for(i=0;i<=5;i++){ var yy=h-(i*0.2*h); var t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',w+6); t.setAttribute('y',yy+4); t.setAttribute('font-size','10'); t.textContent=(i*20)+'%'; g.appendChild(t); }
}
function computeStats(rows){
  var totalDur=0; for(var i=0;i<rows.length;i++) totalDur+=rows[i].durationMs||0;
  return {count:rows.length, dur:totalDur, avg: rows.length? Math.round(totalDur/rows.length):0};
}
function renderStats(){
  var rows=filteredEvents().filter(function(r){return r.end});
  var agg=aggregateByCause(rows), k=computeStats(rows);
  els.kpiCount.textContent=String(k.count);
  els.kpiDur.textContent=fmtDur(k.dur);
  els.kpiAvg.textContent=fmtDur(k.avg);
  if(agg.length){ els.kpiTop.textContent=agg[0].code; els.kpiTopSub.textContent='Hyppigst: '+agg[0].count+' stk'; } else { els.kpiTop.textContent='—'; els.kpiTopSub.textContent='Hyppigst: —'; }
  renderDonut(els.pieFreq, agg, function(x){return x.count}); renderLegend(els.legendFreq, agg, function(x){return x.count+' stk'});
  renderDonut(els.pieDur, agg, function(x){return x.dur||0});  renderLegend(els.legendDur,  agg, function(x){return fmtShortDur(x.dur||0)});
  renderBars(els.barsFreq, agg, function(x){return x.count+' stk'}, 'count');
  renderBars(els.barsDur,  agg, function(x){return fmtDur(x.dur||0)}, 'dur');
  var mode=els.paretoMode.value||'freq'; renderPareto(els.pareto, agg, mode);
}

/* ========================= Historik tabel/eksport ========================= */
function renderTable(){
  var rows=loadEvents().sort(function(a,b){ return new Date(b.start)-new Date(a.start); });
  var html='', i;
  for(i=0;i<rows.length;i++){
    var ev=rows[i];
    html+='<tr>'+
      '<td style="padding:8px;border-bottom:1px solid var(--divider)"><span class="muted">'+fmtDate(ev.start)+'</span></td>'+
      '<td style="padding:8px;border-bottom:1px solid var(--divider)"><span class="muted">'+(ev.end?fmtDate(ev.end):'—')+'</span></td>'+
      '<td style="padding:8px;border-bottom:1px solid var(--divider)">'+(ev.durationMs?fmtDur(ev.durationMs):'—')+'</td>'+
      '<td style="padding:8px;border-bottom:1px solid var(--divider)">'+(ev.line||'')+'</td>'+
      '<td style="padding:8px;border-bottom:1px solid var(--divider)">'+(ev.orderNo||'')+'</td>'+
      '<td style="padding:8px;border-bottom:1px solid var(--divider)">'+(ev.itemNo||'')+'</td>'+
      '<td style="padding:8px;border-bottom:1px solid var(--divider)"><span class="pill">'+((ev.reason&&ev.reason.code)||'')+'</span> '+((ev.reason&&ev.reason.label)||'')+'</td>'+
      '<td style="padding:8px;border-bottom:1px solid var(--divider)">'+((ev.detailChips||[]).join(', '))+' '+(ev.other||'')+'</td>'+
      '<td style="padding:8px;border-bottom:1px solid var(--divider)">'+(ev.comment||'')+'</td>'+
      '<td style="padding:8px;border-bottom:1px solid var(--divider)">'+(ev.operator||'')+'</td>'+
      '<td style="padding:8px;border-bottom:1px solid var(--divider);text-align:right"><button class="btn" data-action="delete" data-id="'+ev.id+'" type="button">Slet</button></td>'+
    '</tr>';
  }
  els.tableBody.innerHTML=html;
  els.countPosts.textContent=String(rows.length);
  var used=[STORAGE,SETTINGS,HANDOVER].reduce(function(a,k){ return a+bytesLen(localStorage.getItem(k)||''); },0);
  var pct=Math.min(100,Math.round((used/(5*1024*1024))*100));
  els.usageTxt.textContent=pct+'% ('+Math.round(used/1024)+' KB af 5120 KB)'; els.usageFill.style.width=pct+'%';
  renderActivity8h(); renderLog8h(); renderStats();
}
function makeCsv(rows){
  function repl(s){ return String(s||'').split(';').join(','); }
  function clean(s){ return String(s||'').replace(/\n/g,' '); }
  var header=['id','start','slut','varighed_ms','varighed_hhmmss','linje','ordre','vare','kode','kode_label','uddybning','andet','kommentar','operatør'].join(';');
  var body=rows.map(function(r){
    var code=(r.reason&&r.reason.code)||'', label=(r.reason&&r.reason.label)||'';
    return [r.id,r.start,r.end,r.durationMs,fmtDur(r.durationMs||0),repl(r.line),repl(r.orderNo),repl(r.itemNo),code,label,repl((r.detailChips||[]).join('|')),repl(r.other),repl(clean(r.comment)),repl(r.operator)].join(';');
  });
  return header+'\n'+body.join('\n');
}
function download(filename,text){
  var blob=new Blob([text],{type:'text/plain;charset=utf-8;'});
  var url=URL.createObjectURL(blob); var a=document.createElement('a');
  a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(function(){ URL.revokeObjectURL(url); },500);
}

/* ========================= Tema & indstillinger =========================== */
function applyTheme(theme){
  if(theme==='dark') document.documentElement.setAttribute('data-theme','dark');
  else document.documentElement.removeAttribute('data-theme');
}
function applyBrand(){
  var s=loadSettings();
  if(s.brandColor) document.documentElement.style.setProperty('--brand', s.brandColor);
  els.defTo.value=s.defaultTo||'vedligehold@pluspack.com';
  els.brandColor.value=s.brandColor||'#0a61ae';
  els.themeSelect.value=s.theme||'standard';
  if(s.line) els.line.value=s.line;
  els.operator.value=s.operator||'';
  els.orderNo.value=s.orderNo||'';
  els.itemNo.value=s.itemNo||'';
  applyTheme(s.theme||'standard');
}

/* ========================= Tabs & events ================================= */
function setActiveTab(which){
  [els.tabHandling,els.tabStats,els.tabHist,els.tabShare,els.tabSettings].forEach(function(t){ remClass(t,'active'); });
  addClass(which,'active');
  [els.viewHandling,els.viewStats,els.viewHist,els.viewShare,els.viewSettings].forEach(hide);
  if(which===els.tabHandling) show(els.viewHandling);
  else if(which===els.tabStats) show(els.viewStats);
  else if(which===els.tabHist) show(els.viewHist);
  else if(which===els.tabShare) show(els.viewShare);
  else show(els.viewSettings);
}
function syncOrder(){
  var s=loadSettings();
  s.orderNo=els.orderNo.value||''; s.itemNo=els.itemNo.value||''; s.operator=els.operator.value||''; s.line=els.line.value||'';
  saveSettings(s);
}
function renderReasonUI(){ renderReasonButtons(); els.stopValidation.textContent=''; }

/* ========================= INIT & handlers ================================ */
window.addEventListener('DOMContentLoaded', function(){
  try{
    setActiveTab(els.tabHandling);
    setStatus(false);
    applyBrand();
    renderTable();
    renderHandover();
    restoreHandoverDraft(); bindDraftAutosave();

    // Tabs
    els.tabHandling.onclick=function(){ setActiveTab(els.tabHandling); };
    els.tabStats.onclick=function(){ setActiveTab(els.tabStats); renderStats(); };
    els.tabHist.onclick=function(){ setActiveTab(els.tabHist); };
    els.tabShare.onclick=function(){ setActiveTab(els.tabShare); };
    els.tabSettings.onclick=function(){ setActiveTab(els.tabSettings); };

    // Filters
    els.shiftSelect.onchange=renderStats;
    els.paretoMode.onchange=renderStats;

    // Inputs sync
    els.line.onchange=syncOrder; els.operator.oninput=syncOrder; els.orderNo.oninput=syncOrder; els.itemNo.oninput=syncOrder;
    els.btnClearOrder.onclick=function(){ els.orderNo.value=''; els.itemNo.value=''; syncOrder(); };
    els.btnClearLine.onclick=function(){ els.line.value=''; els.operator.value=''; syncOrder(); };

    // STOP flow – vis inline-kort i stedet for modal
    els.btnStop.onclick=function(){ show(els.stopInline); renderReasonUI(); };
    els.stopCancel.onclick=function(){ hide(els.stopInline); els.stopValidation.textContent=''; };

    els.stopConfirm.onclick=function(){
      // valider
      if(!(els.orderNo.value||'').trim() || !(els.itemNo.value||'').trim()){
        els.stopValidation.textContent='Udfyld Ordre nr. og Vare nr. før du bekræfter.'; return;
      }
      var sel=document.querySelector('input[name="reasonRadio"]:checked');
      var reason=getReasonByCode(sel?sel.value:null)||{code:'ANDET',label:'Andet'};
      stopMeta={reason:{code:reason.code,label:reason.label},detailChips:selectedChips(),other:(els.other.value||'').trim(),comment:(els.comment.value||'').trim()};
      STOP_START_ISO=new Date().toISOString(); setStatus(true);
      if(timer) clearInterval(timer); timer=setInterval(tick,1000); tick();
      hide(els.stopInline);

      // gem aktuel i localStorage til genoptag
      saveCurrentStop({ start: STOP_START_ISO, meta: stopMeta });
    };

    // START – afslut stop og post
    els.btnStart.onclick=function(){
      if(!IS_STOPPED) return;
      var end=new Date(), start=new Date(STOP_START_ISO), duration=end-start;
      var row={
        id:uuid(),
        start:start.toISOString(), end:end.toISOString(), durationMs:duration,
        line:els.line.value||'', operator:els.operator.value||'',
        orderNo:els.orderNo.value||'', itemNo:els.itemNo.value||'',
        reason:stopMeta?stopMeta.reason:null, detailChips:stopMeta?stopMeta.detailChips:[],
        other:stopMeta?stopMeta.other:'', comment:stopMeta?stopMeta.comment:''
      };
      var rows=loadEvents(); rows.push(row); saveEvents(rows);

      // send til server (valgfrit)
      var payload=Object.assign({Type:'stop'}, row);
      postJSON(ENDPOINT_STOP, payload).then(function(ok){
        if(!ok) alert('Ingen forbindelse – stop er lagt i kø.');
        setStatus(false); STOP_START_ISO=null; stopMeta=null;
        if(timer){clearInterval(timer); timer=null;}
        renderTable(); // forny KPI/log/aktivitet
        clearCurrentStop();
      });
    };

    // Genveje
    document.addEventListener('keydown', function(ev){
      if(ev.ctrlKey && (ev.key==='s' || ev.key==='S')){ ev.preventDefault(); if(!IS_STOPPED){ els.btnStop.click(); } }
      if(ev.ctrlKey && (ev.key==='a' || ev.key==='A')){ ev.preventDefault(); if(IS_STOPPED){ els.btnStart.click(); } }
    });

    // Historik – delete
    els.tableBody.onclick=function(e){
      var t=e.target;
      while(t && t.tagName!=='BUTTON' && t!==els.tableBody) t=t.parentNode;
      if(!t || t===els.tableBody) return;
      var id=t.getAttribute('data-id'), act=t.getAttribute('data-action'), rows=loadEvents();
      if(act==='delete'){
        if(!confirm('Slet denne registrering?')) return;
        saveEvents(rows.filter(function(r){return r.id!==id;}));
        renderTable();
      }
    };

    // Deling/Export
    els.btnCsv.onclick=function(){ download('produktionsstop.csv', makeCsv(loadEvents())); };
    els.btnJson.onclick=function(){
      var json=JSON.stringify(loadEvents(),null,2);
      try{ navigator.clipboard.writeText(json); alert('JSON kopieret'); }
      catch(e){ prompt('Kopiér JSON:', json); }
    };
    els.btnClearLog.onclick=function(){ if(confirm('Slet hele loggen?')){ saveEvents([]); renderTable(); } };
    els.btnArchive.onclick=function(){
      var rows=loadEvents(); if(!rows.length){ alert('Ingen data at arkivere.'); return; }
      var d=new Date(), y=d.getFullYear(), mo=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'), hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0');
      var name='produktionsstop_'+y+mo+da+'_'+hh+mm+'.csv';
      download(name, makeCsv(rows));
      if(confirm('Log blev eksporteret. Vil du nulstille loggen nu?')){ saveEvents([]); renderTable(); }
    };

    // Indstillinger
    els.btnSaveSettings.onclick=function(){
      var s=loadSettings();
      s.defaultTo=els.defTo.value||'';
      s.brandColor=els.brandColor.value||'#0a61ae';
      s.theme=els.themeSelect.value||'standard';
      saveSettings(s); applyBrand(); alert('Indstillinger gemt.');
    };

    // Årsager – indstillinger
    function renderCustomList(){
      var s=loadSettings(), list=s.customCauses||[];
      if(!list.length){ $('causeList').innerHTML='<p class="muted">Ingen brugerdefinerede årsager endnu.</p>'; return; }
      var html='<table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Kode</th><th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Label</th><th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Chips</th><th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb">Handling</th></tr></thead><tbody>';
      for(var i=0;i<list.length;i++){
        var it=list[i];
        html+='<tr><td style="padding:6px;border-bottom:1px solid #e5e7eb">'+it.code+'</td><td style="padding:6px;border-bottom:1px solid #e5e7eb">'+it.label+'</td><td style="padding:6px;border-bottom:1px solid #e5e7eb">'+(it.chips||[]).join(', ')+'</td><td style="padding:6px;border-bottom:1px solid #e5e7eb" class="right"><button class="btn" data-del="'+it.code+'">Slet</button></td></tr>';
      }
      html+='</tbody></table>'; $('causeList').innerHTML=html;
      var delBtns=$('causeList').querySelectorAll('button'); for(var j=0;j<delBtns.length;j++){
        delBtns[j].onclick=function(){
          var code=this.getAttribute('data-del'), s=loadSettings(), arr=s.customCauses||[];
          s.customCauses=arr.filter(function(x){return x.code!==code;}); saveSettings(s); renderCustomList();
        };
      }
    }
    $('btn-add-cause').onclick=function(){
      var code=($('causeCode').value||'').trim().toUpperCase();
      var label=($('causeLabel').value||'').trim();
      var raw=($('causeChips').value||'').split(','), chips=[];
      for(var i=0;i<raw.length;i++){ var t=raw[i].trim(); if(t) chips.push(t); }
      if(!code||!label){ alert('Udfyld både kode og label'); return; }
      var all=getAllReasons(); for(i=0;i<all.length;i++){ if(all[i].code.toUpperCase()===code){ alert('Koden findes allerede. Vælg en anden.'); return; } }
      var s=loadSettings(); if(!s.customCauses) s.customCauses=[]; s.customCauses.push({code:code,label:label,chips:chips}); saveSettings(s);
      $('causeCode').value=''; $('causeLabel').value=''; $('causeChips').value='';
      renderCustomList(); alert('Årsag tilføjet');
    };
    $('btn-reset-causes').onclick=function(){
      if(confirm('Nulstil egne årsager og statistik?')){
        var s=loadSettings(); s.customCauses=[]; saveSettings(s);
        renderCustomList(); alert('Årsager nulstillet.');
      }
    };
    renderCustomList();

    // Genoptag aktivt stop fra CURRENT_STOP
    var cur=loadCurrentStop();
    if(cur && cur.start){
      STOP_START_ISO=cur.start; stopMeta=cur.meta||null; setStatus(true);
      if(timer) clearInterval(timer);
      timer=setInterval(function(){
        if(IS_STOPPED && STOP_START_ISO){
          var ms=Date.now()-new Date(STOP_START_ISO);
          els.liveTimer.textContent=fmtDur(ms);
        }
        renderActivity8h(); renderLog8h();
      }, 1000);
    }

    // Handover
    els.handoverSave.onclick=function(){
      var txt=(els.handoverText.value||'').trim(); if(!txt){ alert('Skriv en note.'); return; }
      var tag=(els.handoverTag.value||'').trim();
      var arr=loadHandover(); arr.unshift({ts:new Date().toISOString(), txt:txt, tag:tag}); saveHandover(arr);
      clearDraft(); els.handoverText.value=''; els.handoverTag.value=''; renderHandover();
    };
    els.handoverClear.onclick=function(){ els.handoverText.value=''; els.handoverTag.value=''; clearDraft(); };

  }catch(err){
    console.error(err); alert('JavaScript-fejl under init: '+err.message);
  }
});
</script>
</body>
</html>
